name: Update Documents

on:
  push:

jobs:
  wiki:
    runs-on: ubuntu-latest

    steps:
      # Check out source repository
      - name: Checkout source repository
        uses: actions/checkout@v3

      # Get the current branch name and tag
      - name: Get current branch name and tag
        id: vars
        run: |
          # Get the latest tag
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "0.0.0")
      
          if [[ "${GITHUB_REF}" == refs/heads/* ]]; then
            BRANCH_NAME=${GITHUB_REF#refs/heads/}
            echo "branch_name=${BRANCH_NAME}" >> $GITHUB_ENV
      
            # Get the short SHA of the current commit
            COMMIT_SHA=$(git rev-parse --short HEAD)
            echo "TAG=${LATEST_TAG}-${COMMIT_SHA}" >> $GITHUB_ENV
            echo "Using branch '${BRANCH_NAME}', generated TAG '${LATEST_TAG}-${COMMIT_SHA}'"
          elif [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            # If there is already a label, use the label directly
            TAG=${GITHUB_REF#refs/tags/}
            echo "TAG=${TAG}" >> $GITHUB_ENV
          else
            # If neither, use the default tag and dev tags
            echo "TAG=${LATEST_TAG}-dev" >> $GITHUB_ENV
          fi
      
          echo "Generated TAG=${TAG}"

      # Push Document to target repository
      - name: Push Documentation to Stayforge.wiki
        if: env.TAG != ''
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git clone https://github.com/tokujun-t/Stayforge.wiki.git Stayforge.wiki
          cd Stayforge.wiki
          cp -r ../docs/wiki/* .
          git add .
          git commit -m "Update Wiki Documentation [skip ci]" || echo "No changes to commit"
          git push origin main
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
